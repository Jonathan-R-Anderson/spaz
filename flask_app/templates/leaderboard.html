{% extends "base.html" %}

{% block content %}
<div id="leaderboard-container">
    <h1>Leaderboard</h1>
    <table id="leaderboard">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Team/User</th>
                <th>Score</th>
            </tr>
        </thead>
        <tbody>
            <!-- Leaderboard entries will be populated here -->
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
<script>
    const gremlinLeaderboardABI = {{ abi|safe }};
    const contractAddress = "{{ contract_address }}"; // Provide the correct contract address

    document.addEventListener("DOMContentLoaded", async function() {
        if (typeof window.ethereum !== 'undefined') {
            const web3 = new Web3(window.ethereum);
            await window.ethereum.enable(); // Request account access
            const contract = new web3.eth.Contract(gremlinLeaderboardABI, contractAddress);

            try {
                // Fetch the leaderboard data from the smart contract
                const leaderboardData = await contract.methods.getLeaderboard().call();
                
                const tbody = document.querySelector("#leaderboard tbody");
                
                // Populate the leaderboard
                leaderboardData.forEach((entry, index) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${entry.entity}</td>
                        <td>${entry.score}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Error fetching leaderboard data:", error);
                alert("Failed to load leaderboard. Make sure MetaMask is connected.");
            }
        } else {
            alert('Ethereum provider not found! Please install MetaMask.');
        }
    });
</script>

{% endblock %}
