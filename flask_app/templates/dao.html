{% extends "base.html" %}

{% block content %}
<div id="dao-management-container">
    <h1>DAO Management</h1>

    <!-- Treasury Overview Section -->
    <div id="dao-treasury">
        <h2>Treasury Pool</h2>
        <p>Current Treasury Balance: <span id="treasury-balance">Loading...</span> ETH</p>
        <button id="withdraw-treasury-btn" disabled>Withdraw DAO Balance</button>
    </div>

    <!-- DAO Parameters Section -->
    <div id="dao-parameters">
        <h2>DAO Settings</h2>
        <form id="dao-settings-form">
            <label for="dao-tax">DAO Tax Percentage (Max 20%):</label>
            <input type="number" id="dao-tax" min="0" max="20" step="1" required>
            <button type="submit" id="update-dao-settings-btn">Update DAO Settings</button>
        </form>
    </div>

    <!-- Active Challenges Management -->
    <div id="active-challenges">
        <h2>Manage Active Challenges</h2>
        <ul id="challenges-list">
            <!-- List items will be dynamically populated here -->
        </ul>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
<script>
    const abi = {{ abi|safe }};
    const contractAddress = "{{ contract_address }}";
    const gremlinDAOABI = {{ gremlinDAOABI|safe }};

    let daoContract;
    let currentAccount;

    // Initialize Web3 and fetch the treasury balance and challenges
    async function initializeWeb3() {
        if (typeof window.ethereum !== 'undefined') {
            const web3 = new Web3(window.ethereum);
            await window.ethereum.enable();
            currentAccount = (await web3.eth.getAccounts())[0];

            daoContract = new web3.eth.Contract(gremlinDAOABI, contractAddress);

            // Fetch treasury balance
            const treasuryBalance = await daoContract.methods.daoBalance().call();
            document.getElementById('treasury-balance').innerText = web3.utils.fromWei(treasuryBalance, 'ether');

            // Fetch active challenges
            const challengeCount = await daoContract.methods.challengeCount().call();
            const challengesList = document.getElementById('challenges-list');
            challengesList.innerHTML = '';

            for (let i = 0; i < challengeCount; i++) {
                const challenge = await daoContract.methods.getChallengeDetails(i).call();
                if (challenge.active) {
                    const challengeItem = document.createElement('li');
                    challengeItem.innerHTML = `
                        <h3>${challenge.category}: ${challenge.name}</h3>
                        <p>${challenge.description}</p>
                        <p>Prize Pool: ${web3.utils.fromWei(challenge.prizePool, 'ether')} ETH</p>
                        <button onclick="endChallenge(${i})">End Challenge</button>
                        <button onclick="removeChallenge(${i})">Remove Challenge</button>
                    `;
                    challengesList.appendChild(challengeItem);
                }
            }

            // Enable withdraw button if there is a balance
            document.getElementById('withdraw-treasury-btn').disabled = treasuryBalance <= 0;
        } else {
            alert('Ethereum provider not found. Please install MetaMask.');
        }
    }

    // Handle DAO settings update (updating tax percentage)
    document.getElementById('dao-settings-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        const taxPercentage = document.getElementById('dao-tax').value;

        try {
            await daoContract.methods.updateDAOTax(taxPercentage).send({ from: currentAccount });
            alert('DAO tax updated successfully!');
        } catch (error) {
            console.error(error);
            alert('Failed to update DAO tax.');
        }
    });

    // Handle challenge ending
    async function endChallenge(challengeId) {
        try {
            await daoContract.methods.endChallenge(challengeId).send({ from: currentAccount });
            alert('Challenge ended successfully!');
            window.location.reload();
        } catch (error) {
            console.error(error);
            alert('Failed to end challenge.');
        }
    }

    // Handle challenge removal
    async function removeChallenge(challengeId) {
        try {
            await daoContract.methods.removeChallenge(challengeId).send({ from: currentAccount });
            alert('Challenge removed successfully!');
            window.location.reload();
        } catch (error) {
            console.error(error);
            alert('Failed to remove challenge.');
        }
    }

    // Handle DAO balance withdrawal
    document.getElementById('withdraw-treasury-btn').addEventListener('click', async function() {
        try {
            await daoContract.methods.withdrawDAOBalance(currentAccount).send({ from: currentAccount });
            alert('DAO balance withdrawn successfully!');
            window.location.reload();
        } catch (error) {
            console.error(error);
            alert('Failed to withdraw DAO balance.');
        }
    });

    // Initialize the page
    window.onload = function() {
        initializeWeb3();
    };
</script>

<style>
    /* Apply theme styling */
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f0f0f0;
    }

    #dao-management-container {
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
        color: #333;
    }

    #dao-treasury, #dao-parameters, #active-challenges {
        margin-bottom: 20px;
    }

    #dao-settings-form input, button {
        display: block;
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    button {
        background-color: #007bff;
        color: #fff;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }
</style>

{% endblock %}
