<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rent Resources with DAO</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .section {
      margin-bottom: 20px;
    }
    .section label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .summary {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }
    #jupyter-embed {
      margin-top: 20px;
      border: 1px solid #ccc;
      width: 100%;
      height: 400px;
    }
    canvas {
      margin-top: 20px;
      width: 100%;
      height: 300px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Rent Resources</h1>

    <div class="section">
      <label for="cores">Number of Cores:</label>
      <input type="number" id="cores" min="1" max="128" value="1">
    </div>

    <div class="section">
      <label for="gpu">Select GPU:</label>
      <select id="gpu"></select>
    </div>

    <div class="section">
      <label for="ram">RAM Allocation (in GB):</label>
      <input type="number" id="ram" min="1" max="512" value="1">
    </div>

    <div class="summary">
      Total Cost: $<span id="total-cost">0</span>/hour
    </div>

    <button id="purchase-tokens">Purchase Tokens</button>
    <button id="launch-notebook">Launch Jupyter Notebook</button>
    <div id="status"></div>

    <!-- Embed Jupyter Notebook -->
    <iframe id="jupyter-embed" src="" style="display: none;"></iframe>

    <!-- Rolling Graph for Usage Statistics -->
    <canvas id="usage-chart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const daoABI = [...]; // DAO Contract ABI
    const tokenABI = [...]; // GremlinToken Contract ABI
    const daoAddress = "0xYourDAOTreasuryAddress";
    const tokenAddress = "0xYourGremlinTokenAddress";
    const web3 = new Web3(window.ethereum);
    const daoContract = new web3.eth.Contract(daoABI, daoAddress);
    const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);

    const coresInput = document.getElementById('cores');
    const gpuSelect = document.getElementById('gpu');
    const ramInput = document.getElementById('ram');
    const totalCostElement = document.getElementById('total-cost');
    const purchaseTokensButton = document.getElementById('purchase-tokens');
    const launchNotebookButton = document.getElementById('launch-notebook');
    const statusDiv = document.getElementById('status');
    const jupyterEmbed = document.getElementById('jupyter-embed');

    let gpuRates = {};
    let coreRate = 0;
    let ramRate = 0;
    let usageData = { cpu: [], ram: [], gpu: [] };

    const usageChart = new Chart(document.getElementById('usage-chart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'CPU Usage', data: [], borderColor: 'red', fill: false },
          { label: 'RAM Usage', data: [], borderColor: 'blue', fill: false },
          { label: 'GPU Usage', data: [], borderColor: 'green', fill: false }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { type: 'linear', title: { display: true, text: 'Time (seconds)' } },
          y: { beginAtZero: true, title: { display: true, text: 'Usage (%)' } }
        }
      }
    });

    async function fetchRates() {
      const accounts = await web3.eth.requestAccounts();
      const rates = await daoContract.methods.getResourceRates().call({ from: accounts[0] });
      coreRate = web3.utils.fromWei(rates[0], 'ether');
      ramRate = web3.utils.fromWei(rates[1], 'ether');
      gpuRates = rates[2].reduce((acc, gpu, index) => {
        acc[gpu] = web3.utils.fromWei(rates[3][index], 'ether');
        return acc;
      }, {});
      updateGpuOptions();
      calculateCost();
    }

    function updateGpuOptions() {
      gpuSelect.innerHTML = '<option value="none" data-price="0">None</option>';
      for (const [gpu, price] of Object.entries(gpuRates)) {
        const option = document.createElement('option');
        option.value = gpu;
        option.dataset.price = price;
        option.textContent = `${gpu} ($${price}/hour)`;
        gpuSelect.appendChild(option);
      }
    }

    async function calculateCost() {
      const cores = parseInt(coresInput.value);
      const gpuType = gpuSelect.value;
      const gpuPrice = gpuRates[gpuType] || 0;
      const ram = parseInt(ramInput.value);

      const totalCost = (cores * coreRate) + gpuPrice + (ram * ramRate);
      totalCostElement.textContent = totalCost.toFixed(2);
    }

    async function purchaseTokens() {
      try {
        const ethAmount = prompt("Enter the amount of ETH to spend:");
        if (!ethAmount) return;

        const accounts = await web3.eth.requestAccounts();
        await daoContract.methods.purchaseTokens().send({
          from: accounts[0],
          value: web3.utils.toWei(ethAmount, 'ether')
        });

        alert("Tokens purchased successfully!");
      } catch (error) {
        alert(`Error purchasing tokens: ${error.message}`);
      }
    }

    async function launchNotebook() {
      try {
        const accounts = await web3.eth.requestAccounts();
        const cores = parseInt(coresInput.value);
        const gpu = gpuSelect.value;
        const ram = parseInt(ramInput.value);

        const result = await daoContract.methods.allocateResourcesForUser(cores, gpu, ram).send({ from: accounts[0] });
        const profile = await daoContract.methods.getUpdatedProfile(accounts[0]).call({ from: accounts[0] });
        const remainingFunds = web3.utils.fromWei(profile[3], 'ether');
        const timeRemaining = profile[4];

        alert(`Notebook launched! Transaction: ${result.transactionHash}`);
        statusDiv.innerHTML = `Remaining Funds: ${remainingFunds} ETH, Time Remaining: ${timeRemaining} seconds`;

        jupyterEmbed.src = "http://your-jupyter-url/notebook"; // Replace with your Jupyter URL
        jupyterEmbed.style.display = "block";

        startUsageTracking();
      } catch (error) {
        alert(`Error launching notebook: ${error.message}`);
      }
    }

    function startUsageTracking() {
      setInterval(() => {
        const now = Date.now();
        usageData.cpu.push({ x: now, y: Math.random() * 100 });
        usageData.ram.push({ x: now, y: Math.random() * 100 });
        usageData.gpu.push({ x: now, y: Math.random() * 100 });

        updateUsageChart();
      }, 1000);
    }

    function updateUsageChart() {
      usageChart.data.labels = usageData.cpu.map(point => point.x);
      usageChart.data.datasets[0].data = usageData.cpu.map(point => point.y);
      usageChart.data.datasets[1].data = usageData.ram.map(point => point.y);
      usageChart.data.datasets[2].data = usageData.gpu.map(point => point.y);
      usageChart.update();
    }

    coresInput.addEventListener('input', calculateCost);
    gpuSelect.addEventListener('change', calculateCost);
    ramInput.addEventListener('input', calculateCost);
    purchaseTokensButton.addEventListener('click', purchaseTokens);
    launchNotebookButton.addEventListener('click', launchNotebook);

    fetchRates();
  </script>
</body>
</html>
