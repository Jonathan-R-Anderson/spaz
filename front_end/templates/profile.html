{% extends "base.html" %}

{% block content %}
<head>
<style>
    #video-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 20px auto;
    width: 80%;
    max-width: 800px;
    border: 2px solid #ddd;
    border-radius: 8px;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    background-color: #f9f9f9;
    padding: 20px;
}

video {
    width: 100%;
    height: auto;
    background-color: black;
    border-radius: 8px;
}

#status-message {
    text-align: center;
    font-size: 1.2em;
    color: #333;
    margin-top: 10px;
}

#torrent-graph-container {
    margin-top: 20px;
    width: 80%;
    max-width: 800px;
}

#profile-container {
    margin-top: 30px;
    width: 80%;
    max-width: 800px;
    text-align: center;
}

h1, h2, h3 {
    color: #333;
}

</style>
</head>


<div id="video-container">
    <video id="player" autoplay playsinline controls muted style="width: 100%; height: 60vh; background-color: black;">
        <p class="vjs-no-js">
            To view this video, please enable JavaScript, and consider upgrading to a web browser that
            <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
        </p>
    </video>
    <p id="status-message">Loading stream...</p>
</div>

<!-- Torrent Graph to visualize download and connection stats -->
<div id="torrent-graph-container" style="width: 100%; height: 250px; margin-top: 20px;">
    <canvas id="torrent-graph" width="100%" height="100%" style="background-color: #f9f9f9;"></canvas>
</div>

<!-- Profile container and other page elements -->
<div id="profile-container">
    <h1>User Profile</h1>
    <h2 id="profile-name">Ethereum Address: <span id="eth-address">{{ eth_address }}</span></h2>

    <!-- Spider chart for user skills -->
    <h3>User Skills Overview</h3>
    <canvas id="skillChart"></canvas>

    <!-- List of Published Papers -->
    <h3>Published Papers</h3>
    <ul id="published-papers-list"></ul>
    <p id="no-papers-message" style="display:none;">No papers have been published yet.</p>

    <!-- Overall User Rating -->
    <h3>Overall User Rating: <span id="user-rating">N/A</span></h3>
    <p id="no-rating-message" style="display:none;">This user has not been rated yet.</p>

    <!-- Tipping Section (hidden if it's the user's own profile) -->
    <div id="tip-section" style="display:none;">
        <h3>Tip the Author</h3>
        <form id="tip-form">
            <input type="number" id="tip-amount" placeholder="Enter amount in ETH" min="0.01" step="0.01" required>
            <button type="submit">Tip</button>
        </form>
    </div>
</div>

<div id="custom-html-content"></div>


{% endblock %}

{% block scripts %}
<script src="https://webtorrent.io/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>

<script>
    const ethAddress = "{{ eth_address }}";
    const client = new WebTorrent();
    const videoElement = document.getElementById("player");
    let videoQueue = [];
    let processedSegmentIds = new Set();
    let currentVideoIndex = 0;
    let isPlaying = false;
    
    // Contract setup
    const web3 = new Web3(window.ethereum);
    const spazLivestreamAddress = {{ livestreamAddress | safe }};  // Replace with actual address
    const spazLivestreamABI = {{ livestreamABI | safe }}; // Paste the ABI array here
    
    const spazLivestream = new web3.eth.Contract(spazLivestreamABI, spazLivestreamAddress);
    
    // Specify which streamId to load
    const streamId = 1;
    
    document.addEventListener("DOMContentLoaded", async () => {
        await window.ethereum.enable(); // Prompt user to connect wallet
        loadLivestreamSegments(streamId);
    });
    
    async function loadLivestreamSegments(streamId) {
        try {
            const segmentIds = await spazLivestream.methods.getSegmentChain(streamId).call();
            segmentIds.sort((a, b) => a - b);  // Ensure ascending order
    
            for (const segmentId of segmentIds) {
                if (!processedSegmentIds.has(segmentId)) {
                    const [magnetURI] = await spazLivestream.methods.getSegment(segmentId).call();
                    downloadAndQueueMagnet(magnetURI, segmentId);
                    processedSegmentIds.add(segmentId);
                }
            }
        } catch (err) {
            console.error("Error loading stream segments:", err);
        }
    }
    
    function downloadAndQueueMagnet(magnetUrl, segmentId) {
        console.log("Downloading segment:", segmentId, magnetUrl);
    
        client.add(magnetUrl, function (torrent) {
            setupTorrentGraph(torrent);
            const file = torrent.files.find(file => file.name.endsWith('.mp4'));
    
            if (file) {
                file.getBlobURL((err, url) => {
                    if (err) return console.error("Blob error:", err);
                    videoQueue.push({ url, snapshotIndex: segmentId });
                    videoQueue.sort((a, b) => a.snapshotIndex - b.snapshotIndex);
                    if (!isPlaying && videoQueue.length > 0) {
                        playNextInQueue();
                    }
                });
            }
        });
    }
    
    function playNextInQueue() {
        if (currentVideoIndex < videoQueue.length) {
            const video = videoQueue[currentVideoIndex];
            videoElement.src = video.url;
            videoElement.load();
            videoElement.play().then(() => {
                isPlaying = true;
            }).catch(console.error);
        }
    }
    
    function handleVideoEnd() {
        currentVideoIndex++;
        isPlaying = false;
        if (currentVideoIndex < videoQueue.length) {
            playNextInQueue();
        }
    }
    
    videoElement.addEventListener('ended', handleVideoEnd);
    
    // Optional tip function
    async function tipStreamer(amountInEth) {
        try {
            const accounts = await web3.eth.getAccounts();
            const from = accounts[0];
    
            await spazLivestream.methods.tipStreamer(streamId).send({
                from,
                value: web3.utils.toWei(amountInEth.toString(), "ether")
            });
    
            alert("Tip sent successfully!");
        } catch (err) {
            console.error("Error tipping:", err);
            alert("Failed to send tip");
        }
    }
    </script>
    

{% endblock %}
